<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住院醫師座談會成效追蹤儀表板</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
        }

        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: #f8f7f5;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* 頭部 */
        .header {
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 0.95rem;
            color: #7f8c8d;
        }

        /* 按鈕組 */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: "Noto Sans TC", sans-serif;
        }

        .btn-primary {
            background-color: #9ba8b8;
            color: white;
        }

        .btn-primary:hover {
            background-color: #8a96a6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(155, 168, 184, 0.3);
        }

        .btn-secondary {
            background-color: #e8e6e3;
            color: #2c3e50;
        }

        .btn-secondary:hover {
            background-color: #ddd9d3;
        }

        /* 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: rgba(61, 61, 61, 0.08) 0px 2px 8px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: rgba(61, 61, 61, 0.12) 0px 4px 12px;
            transform: translateY(-2px);
        }

        .stat-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-card.primary {
            background: linear-gradient(135deg, #a8b8a0 0%, #9ba8b8 100%);
            color: white;
        }

        .stat-label {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-detail {
            font-size: 0.85rem;
            opacity: 0.85;
        }

        /* 圖表區域 */
        .chart-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        .chart-container {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: rgba(61, 61, 61, 0.08) 0px 2px 8px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }

        /* 追蹤項目 */
        .tracking-items {
            margin-top: 2rem;
        }

        .tracking-item {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: rgba(61, 61, 61, 0.08) 0px 2px 8px;
            border-left: 4px solid #9ba8b8;
            transition: all 0.3s ease;
        }

        .tracking-item:hover {
            box-shadow: rgba(61, 61, 61, 0.12) 0px 4px 12px;
            transform: translateX(4px);
        }

        .tracking-item.pending {
            border-left-color: #b8a898;
        }

        .tracking-item.in-progress {
            border-left-color: #9ba8b8;
        }

        .tracking-item.completed {
            border-left-color: #a8b8a0;
        }

        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: rgba(184, 168, 152, 0.15);
            color: rgb(184, 168, 152);
        }

        .status-in-progress {
            background-color: rgba(155, 168, 184, 0.15);
            color: rgb(155, 168, 184);
        }

        .status-completed {
            background-color: rgba(168, 184, 160, 0.15);
            color: rgb(168, 184, 160);
        }

        .category-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            font-weight: 500;
            background-color: #e8e6e3;
            color: #2c3e50;
            margin-right: 0.5rem;
        }

        .tracking-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .tracking-proposer {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }

        .tracking-progress {
            font-size: 0.9rem;
            color: #2c3e50;
            margin-top: 0.5rem;
            line-height: 1.5;
        }

        .progress-bar {
            height: 6px;
            background-color: rgb(232, 230, 227);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, rgb(168, 184, 160), rgb(155, 168, 184));
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        /* 加載狀態 */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #e8e6e3;
            border-top: 4px solid #9ba8b8;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 2rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* 頁腳 */
        .footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid #e8e6e3;
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .refresh-btn {
            background-color: #a8b8a0;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background-color: #97a68f;
        }

        .last-update {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 頭部 -->
        <div class="header">
            <h1>住院醫師座談會成效追蹤儀表板</h1>
            <p id="meeting-date">12/24/2025 座談會</p>
        </div>

        <!-- 按鈕組 -->
        <div class="button-group">
            <button class="btn btn-primary" id="meeting-btn">1141224座談會</button>
            <button class="btn btn-secondary refresh-btn" onclick="loadData()">重新整理</button>
        </div>

        <!-- 統計卡片 -->
        <div class="stats-grid" id="stats-container">
            <div class="card stat-card primary">
                <div class="stat-label">整體達成率</div>
                <div class="stat-value" id="completion-rate">11%</div>
                <div class="stat-detail" id="completion-detail">1/9</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">待決議</div>
                <div class="stat-value" id="pending-count">2</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">進行中</div>
                <div class="stat-value" id="in-progress-count">6</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">已結案</div>
                <div class="stat-value" id="completed-count">1</div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="chart-section">
            <h2 class="section-title">議題類別統計</h2>
            <div class="chart-container">
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- 追蹤項目 -->
        <div class="tracking-items">
            <h2 class="section-title">追蹤項目</h2>
            <div id="tracking-list" class="loading">
                <div class="spinner"></div>
                <p>載入中...</p>
            </div>
        </div>

        <!-- 頁腳 -->
        <div class="footer">
            <p>Made with ❤️ for Resident Meeting Tracking</p>
            <div class="last-update">
                最後更新：<span id="last-update-time">-</span>
            </div>
        </div>
    </div>

    <script>
        // 配置
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbwp8wbNQaU0J9SQX6r1EUdhuAvnfDgsyfSXkIjtOHtGeXgu8hSN5_jKQ9_WqpFbvhkR9g/exec',
            REFRESH_INTERVAL: 5 * 60 * 1000
        };

        // 莫蘭迪色系
        const COLORS = {
            pending: '#b8a898',
            inProgress: '#9ba8b8',
            completed: '#a8b8a0',
            categories: ['#9ba8b8', '#b8a898', '#a8b8a0', '#9b9fa8', '#a8a8a8']
        };

        let chartInstance = null;
        let allData = null;

        // 載入資料
        async function loadData() {
            try {
                console.log('正在從 Google Sheets 載入資料...');
                const response = await fetch(CONFIG.API_URL);
                const data = await response.json();
                
                allData = data;
                console.log('資料已載入:', data);

                // 更新統計信息
                updateStats(data);

                // 更新圖表
                updateChart(data);

                // 更新追蹤列表
                updateTrackingList(data);

                // 更新時間戳
                updateTimestamp();
            } catch (error) {
                console.error('載入資料失敗:', error);
                document.getElementById('tracking-list').innerHTML = 
                    '<p style="color: #e74c3c;">載入資料失敗，請檢查網路連接或稍後重試。</p>';
            }
        }

        // 更新統計卡片
        function updateStats(data) {
            if (!data.tracking || data.tracking.length === 0) return;

            const tracking = data.tracking;
            const pending = tracking.filter(item => item.status === '待決議').length;
            const inProgress = tracking.filter(item => item.status === '進行中').length;
            const completed = tracking.filter(item => item.status === '已結案').length;
            const total = tracking.length;
            const completionRate = Math.round((completed / total) * 100);

            document.getElementById('completion-rate').textContent = completionRate + '%';
            document.getElementById('completion-detail').textContent = `${completed}/${total}`;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('in-progress-count').textContent = inProgress;
            document.getElementById('completed-count').textContent = completed;
        }

        // 更新圖表
        function updateChart(data) {
            if (!data.tracking || data.tracking.length === 0) return;

            const tracking = data.tracking;
            const categories = {};

            tracking.forEach(item => {
                const category = item.category || '其他';
                categories[category] = (categories[category] || 0) + 1;
            });

            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        label: '提案數',
                        data: Object.values(categories),
                        backgroundColor: COLORS.categories,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 2
                            }
                        }
                    }
                }
            });
        }

        // 更新追蹤列表
        function updateTrackingList(data) {
            if (!data.tracking || data.tracking.length === 0) {
                document.getElementById('tracking-list').innerHTML = '<p>暫無追蹤項目</p>';
                return;
            }

            const tracking = data.tracking;
            let html = '';

            tracking.forEach(item => {
                const statusClass = item.status === '待決議' ? 'pending' : 
                                   item.status === '進行中' ? 'in-progress' : 'completed';
                const statusBadgeClass = item.status === '待決議' ? 'status-pending' : 
                                        item.status === '進行中' ? 'status-in-progress' : 'status-completed';

                html += `
                    <div class="tracking-item ${statusClass}">
                        <div class="tracking-header">
                            <div>
                                <span class="status-badge ${statusBadgeClass}">${item.status}</span>
                                <span class="category-badge">${item.category}</span>
                            </div>
                        </div>
                        <div class="tracking-title">${item.target}</div>
                        <div class="tracking-proposer">提案者：${item.proposer}</div>
                        ${item.tracking_report ? `<div class="tracking-progress"><strong>追蹤進度：</strong>${item.tracking_report}</div>` : ''}
                        ${item.tracking_date ? `<div class="tracking-progress"><strong>追蹤日期：</strong>${item.tracking_date}</div>` : ''}
                    </div>
                `;
            });

            document.getElementById('tracking-list').innerHTML = html;
        }

        // 更新時間戳
        function updateTimestamp() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-TW');
            document.getElementById('last-update-time').textContent = timeString;
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setInterval(loadData, CONFIG.REFRESH_INTERVAL);
        });
    </script>
</body>
</html>
